<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cutting Board Designer</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        @media screen {
            #printable-instructions {
                display: none !important;
            }
        }

        @media print {
            /* Hide everything except printable instructions */
            body * {
                visibility: hidden !important;
            }

            #printable-instructions,
            #printable-instructions * {
                visibility: visible !important;
            }

            #printable-instructions {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                background: white !important;
                color: black !important;
                padding: 20px !important;
                display: block !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            #printable-instructions h1,
            #printable-instructions h2,
            #printable-instructions h3 {
                color: black !important;
                page-break-after: avoid;
            }

            #printable-instructions table {
                color: black !important;
                border-collapse: collapse !important;
                page-break-inside: avoid;
            }

            #printable-instructions td,
            #printable-instructions th {
                color: black !important;
            }
        }

        @page {
            margin: 0.5in;
            size: letter;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        // Lucide React icon replacements (simple SVG versions)
        const GripVertical = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="9" cy="12" r="1"></circle>
                <circle cx="9" cy="5" r="1"></circle>
                <circle cx="9" cy="19" r="1"></circle>
                <circle cx="15" cy="12" r="1"></circle>
                <circle cx="15" cy="5" r="1"></circle>
                <circle cx="15" cy="19" r="1"></circle>
            </svg>
        );

        const RotateCw = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
        );

        const Plus = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Trash2 = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const ArrowLeft = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
        );

        const ArrowRight = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="5" y1="12" x2="19" y2="12"></line>
                <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
        );

        const Sparkles = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>
                <path d="M5 3v4"></path>
                <path d="M19 17v4"></path>
                <path d="M3 5h4"></path>
                <path d="M17 19h4"></path>
            </svg>
        );

        const KERF_WIDTH = 0.125; // 1/8 inch

        const WOOD_TYPES = [
            { name: 'Walnut', color: '#3E2723' },
            { name: 'Maple', color: '#F5E6D3' },
            { name: 'Cherry', color: '#A0522D' },
            { name: 'Mahogany', color: '#C04000' },
            { name: 'Oak', color: '#DEB887' },
            { name: 'Purpleheart', color: '#6A0DAD' },
        ];

        const TEMPLATES = {
            checkeredPattern: {
                name: "Checkered Pattern",
                boards: [
                    { id: 1, thickness: '1.5', width: '7', length: '10', woodType: { name: 'Walnut', color: '#3E2723' } },
                    { id: 2, thickness: '1.5', width: '7', length: '10', woodType: { name: 'Maple', color: '#F5E6D3' } },
                ],
                ripWidth: '1',
                crosscutWidth: '1',
                grainOrientation: 'end-grain'
            },
            stripedPattern: {
                name: "Face Grain Stripes",
                boards: [
                    { id: 1, thickness: '0.75', width: '6', length: '16', woodType: { name: 'Cherry', color: '#C96236' } },
                    { id: 2, thickness: '0.75', width: '6', length: '16', woodType: { name: 'Maple', color: '#F5E6D3' } },
                ],
                ripWidth: '1',
                crosscutWidth: '14',
                grainOrientation: 'face-grain'
            },
            wideStripes: {
                name: "Wide Stripes (End Grain)",
                boards: [
                    { id: 1, thickness: '1.5', width: '6', length: '14', woodType: { name: 'Walnut', color: '#3E2723' } },
                    { id: 2, thickness: '1.5', width: '6', length: '14', woodType: { name: 'Oak', color: '#DEB887' } },
                ],
                ripWidth: '2',
                crosscutWidth: '2',
                grainOrientation: 'end-grain'
            },
            threeWoodCheckered: {
                name: "Three Wood Checkered",
                boards: [
                    { id: 1, thickness: '1.5', width: '6', length: '12', woodType: { name: 'Walnut', color: '#3E2723' } },
                    { id: 2, thickness: '1.5', width: '6', length: '12', woodType: { name: 'Maple', color: '#F5E6D3' } },
                    { id: 3, thickness: '1.5', width: '6', length: '12', woodType: { name: 'Cherry', color: '#C96236' } },
                ],
                ripWidth: '1',
                crosscutWidth: '1',
                grainOrientation: 'end-grain'
            }
        };

        function CuttingBoardDesigner() {
            const [step, setStep] = useState(1);
            const [boards, setBoards] = useState([]);
            const [ripWidth, setRipWidth] = useState('');
            const [rippedStrips, setRippedStrips] = useState([]);
            const [crosscutWidth, setCrosscutWidth] = useState('');
            const [crosscutStripCount, setCrosscutStripCount] = useState('');
            const [finalStrips, setFinalStrips] = useState([]);
            const [grainOrientation, setGrainOrientation] = useState('end-grain');
            const [draggedIndex, setDraggedIndex] = useState(null);

            // Load template
            const loadTemplate = (templateKey) => {
                const template = TEMPLATES[templateKey];

                const boardsWithStrips = template.boards.map(board => {
                    const width = parseFloat(board.width);
                    const stripW = parseFloat(template.ripWidth);

                    // Calculate strip count correctly (kerf between strips, not after)
                    let stripCount = 0;
                    let remaining = width;
                    while (remaining >= stripW) {
                        remaining -= (stripW + KERF_WIDTH);
                        stripCount++;
                    }

                    return {
                        ...board,
                        customStrips: [{ width: stripW, quantity: stripCount }]
                    };
                });

                setBoards(boardsWithStrips);
                setRipWidth(template.ripWidth);
                setCrosscutWidth(template.crosscutWidth);
                setGrainOrientation(template.grainOrientation);

                const strips = [];
                const boardGroups = [];

                boardsWithStrips.forEach((board, boardIdx) => {
                    const boardStrips = [];
                    board.customStrips.forEach((customStrip, idx) => {
                        for (let i = 0; i < customStrip.quantity; i++) {
                            boardStrips.push({
                                id: `${board.id}-custom-${idx}-${i}`,
                                boardIndex: boardIdx,
                                width: customStrip.width,
                                length: parseFloat(board.length),
                                thickness: parseFloat(board.thickness),
                                woodType: board.woodType,
                                originalBoard: board.id
                            });
                        }
                    });
                    boardGroups.push(boardStrips);
                });

                const alternated = [];
                const maxLength = Math.max(...boardGroups.map(g => g.length));

                for (let i = 0; i < maxLength; i++) {
                    boardGroups.forEach(group => {
                        if (group[i]) {
                            alternated.push(group[i]);
                        }
                    });
                }

                setRippedStrips(alternated);

                const crossW = parseFloat(template.crosscutWidth);
                const panelLength = alternated.length > 0 ? alternated[0].length : 0;

                let remaining = panelLength;
                let stripCount = 0;
                const crossStrips = [];

                while (remaining >= crossW) {
                    crossStrips.push({
                        id: `cross-${stripCount}`,
                        width: crossW,
                        segments: alternated.map(rs => ({
                            width: rs.width,
                            woodType: rs.woodType
                        })),
                        flipped: stripCount % 2 === 1
                    });
                    remaining -= (crossW + KERF_WIDTH);
                    stripCount++;
                }

                setFinalStrips(crossStrips);
            };

            const addBoard = () => {
                setBoards([...boards, {
                    id: Date.now(),
                    thickness: '',
                    width: '',
                    length: '',
                    woodType: WOOD_TYPES[0],
                    customStrips: []
                }]);
            };

            const updateBoard = (id, field, value) => {
                setBoards(boards.map(b => b.id === id ? { ...b, [field]: value } : b));
            };

            const removeBoard = (id) => {
                setBoards(boards.filter(b => b.id !== id));
            };

            const addCustomStrip = (boardId, width, quantity) => {
                setBoards(boards.map(b => {
                    if (b.id === boardId) {
                        return {
                            ...b,
                            customStrips: [...(b.customStrips || []), { width: parseFloat(width), quantity: parseInt(quantity) || 1 }]
                        };
                    }
                    return b;
                }));
            };

            const removeCustomStrip = (boardId, stripIndex) => {
                setBoards(boards.map(b => {
                    if (b.id === boardId) {
                        return {
                            ...b,
                            customStrips: b.customStrips.filter((_, idx) => idx !== stripIndex)
                        };
                    }
                    return b;
                }));
            };

            const calculateBoardRemaining = (board) => {
                const boardWidth = parseFloat(board.width);
                if (!boardWidth || !board.customStrips || board.customStrips.length === 0) {
                    return { remaining: boardWidth || 0, status: 'ok' };
                }

                let used = 0;
                board.customStrips.forEach(strip => {
                    used += (strip.width * strip.quantity) + (KERF_WIDTH * strip.quantity);
                });
                used -= KERF_WIDTH;

                const remaining = boardWidth - used;

                if (remaining < 0) {
                    return { remaining, status: 'insufficient' };
                } else if (remaining < 0.125) {
                    return { remaining, status: 'ok' };
                } else {
                    return { remaining, status: 'waste' };
                }
            };

            const calculateRippedStrips = () => {
                // Group strips by board
                const boardGroups = [];
                boards.forEach((board, boardIdx) => {
                    const boardStrips = [];
                    if (board.customStrips && board.customStrips.length > 0) {
                        board.customStrips.forEach((customStrip, idx) => {
                            for (let i = 0; i < customStrip.quantity; i++) {
                                boardStrips.push({
                                    id: `${board.id}-custom-${idx}-${i}`,
                                    boardIndex: boardIdx,
                                    width: customStrip.width,
                                    length: parseFloat(board.length),
                                    thickness: parseFloat(board.thickness),
                                    woodType: board.woodType,
                                    originalBoard: board.id
                                });
                            }
                        });
                    }
                    if (boardStrips.length > 0) {
                        boardGroups.push(boardStrips);
                    }
                });

                // Alternate strips between boards
                const alternated = [];
                const maxLength = Math.max(...boardGroups.map(g => g.length), 0);
                for (let i = 0; i < maxLength; i++) {
                    boardGroups.forEach(group => {
                        if (group[i]) {
                            alternated.push(group[i]);
                        }
                    });
                }

                setRippedStrips(alternated);
                setStep(3);
            };

            const calculateCrosscutStrips = () => {
                const strips = [];
                const crossW = parseFloat(crosscutWidth);
                const desiredCount = parseInt(crosscutStripCount) || null;

                const panelLength = rippedStrips.length > 0 ? rippedStrips[0].length : 0;

                let maxStrips = 0;
                let remaining = panelLength;
                while (remaining >= crossW) {
                    remaining -= (crossW + KERF_WIDTH);
                    maxStrips++;
                }

                const stripCount = desiredCount && desiredCount <= maxStrips ? desiredCount : maxStrips;

                for (let i = 0; i < stripCount; i++) {
                    strips.push({
                        id: `cross-${i}`,
                        width: crossW,
                        segments: rippedStrips.map(rs => ({
                            width: rs.width,
                            woodType: rs.woodType
                        })),
                        flipped: i % 2 === 1
                    });
                }

                setFinalStrips(strips);
                setStep(5);
            };

            const handleDragStartRipped = (index) => {
                setDraggedIndex(index);
            };

            const handleDragOverRipped = (e, index) => {
                e.preventDefault();
                if (draggedIndex === null || draggedIndex === index) return;

                const newStrips = [...rippedStrips];
                const draggedItem = newStrips[draggedIndex];
                newStrips.splice(draggedIndex, 1);
                newStrips.splice(index, 0, draggedItem);

                setRippedStrips(newStrips);
                setDraggedIndex(index);
            };

            const handleDragStartFinal = (index) => {
                setDraggedIndex(index);
            };

            const handleDragOverFinal = (e, index) => {
                e.preventDefault();
                if (draggedIndex === null || draggedIndex === index) return;

                const newStrips = [...finalStrips];
                const draggedItem = newStrips[draggedIndex];
                newStrips.splice(draggedIndex, 1);
                newStrips.splice(index, 0, draggedItem);

                setFinalStrips(newStrips);
                setDraggedIndex(index);
            };

            const toggleFlip = (index) => {
                setFinalStrips(finalStrips.map((strip, i) =>
                    i === index ? { ...strip, flipped: !strip.flipped } : strip
                ));
            };

            const getFinalDimensions = () => {
                if (finalStrips.length === 0) return { width: 0, length: 0, thickness: 0 };

                let width, length, thickness;
                const boardThickness = rippedStrips.length > 0 ? rippedStrips[0].thickness : 0;
                const panelWidth = finalStrips[0].segments.reduce((sum, seg) => sum + seg.width, 0);

                if (grainOrientation === 'end-grain') {
                    // End-grain: strips rotated 90¬∞
                    // Width = number of strips √ó board thickness (NO KERFS)
                    width = finalStrips.length * boardThickness;
                    // Length = panel width (NO KERFS)
                    length = panelWidth;
                    // Thickness = crosscut width
                    thickness = parseFloat(crosscutWidth);
                } else {
                    // Face-grain: no rotation
                    // Width = panel width (NO KERFS)
                    width = panelWidth;
                    // Length = number of strips √ó crosscut width (NO KERFS)
                    length = finalStrips.length * parseFloat(crosscutWidth);
                    // Thickness = board thickness
                    thickness = boardThickness;
                }

                return {
                    width: parseFloat(width.toFixed(2)),
                    length: parseFloat(length.toFixed(2)),
                    thickness: parseFloat(thickness.toFixed(2))
                };
            };

            // Save design to JSON file
            const saveDesign = () => {
                const designData = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    boards,
                    ripWidth,
                    rippedStrips,
                    crosscutWidth,
                    crosscutStripCount,
                    finalStrips,
                    grainOrientation,
                    step
                };

                const blob = new Blob([JSON.stringify(designData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cutting-board-design-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            // Load design from JSON file
            const loadDesign = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const designData = JSON.parse(e.target.result);

                        // Restore state
                        setBoards(designData.boards || []);
                        setRipWidth(designData.ripWidth || '');
                        setRippedStrips(designData.rippedStrips || []);
                        setCrosscutWidth(designData.crosscutWidth || '');
                        setCrosscutStripCount(designData.crosscutStripCount || '');
                        setFinalStrips(designData.finalStrips || []);
                        setGrainOrientation(designData.grainOrientation || 'end-grain');
                        setStep(designData.step || 1);

                        alert('Design loaded successfully!');
                    } catch (error) {
                        alert('Error loading design file: ' + error.message);
                    }
                };
                reader.readAsText(file);

                // Reset file input
                event.target.value = '';
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-50 p-8">
                    <div className="max-w-6xl mx-auto">
                        <div className="flex items-center justify-between mb-2 no-print">
                            <div className="flex-1"></div>
                            <h1 className="text-4xl font-bold text-amber-900 text-center flex-1">
                                Cutting Board Designer
                            </h1>
                            <div className="flex-1 flex justify-end gap-2">
                                <button
                                    onClick={saveDesign}
                                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium"
                                    title="Save design to file"
                                >
                                    üíæ Save
                                </button>
                                <label className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm font-medium cursor-pointer">
                                    üìÅ Load
                                    <input
                                        type="file"
                                        accept=".json"
                                        onChange={loadDesign}
                                        className="hidden"
                                    />
                                </label>
                            </div>
                        </div>
                        <p className="text-center text-amber-700 mb-8 no-print">
                            Create beautiful end-grain cutting boards with precision
                        </p>

                        <div className="mb-8 flex items-center justify-center gap-2 no-print">
                            {[1, 2, 3, 4, 5, 6].map((s) => (
                                <div key={s} className="flex items-center">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${
                                        s === step ? 'bg-amber-600 text-white' :
                                        s < step ? 'bg-green-600 text-white' :
                                        'bg-gray-300 text-gray-600'
                                    }`}>
                                        {s}
                                    </div>
                                    {s < 6 && <div className={`w-12 h-1 ${s < step ? 'bg-green-600' : 'bg-gray-300'}`} />}
                                </div>
                            ))}
                        </div>

                        {/* START: Sticky Estimated Final Dimensions - Can be removed by commenting out this section */}
                        <div className="sticky top-0 z-10 mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg shadow-md p-4 no-print">
                            <div className="flex items-center justify-between">
                                <h3 className="text-sm font-bold text-blue-900 flex-shrink-0">Estimated Final Dimensions:</h3>
                                <div className="flex items-center gap-4 text-sm">
                                    {(() => {
                                        // Calculate dimensions based on available data
                                        let width = '?', length = '?', thickness = '?', grain = '?';

                                        // Steps 3+: We have ripped strips
                                        if (step >= 3 && rippedStrips.length > 0) {
                                            const boardThickness = rippedStrips[0].thickness;
                                            const panelWidth = rippedStrips.reduce((sum, s) => sum + s.width, 0);

                                            // Steps 4+: We have crosscut width and grain orientation
                                            if (step >= 4 && crosscutWidth && parseFloat(crosscutWidth) > 0) {
                                                const crossW = parseFloat(crosscutWidth);
                                                const panelLength = rippedStrips[0].length;

                                                // Calculate max or user-specified strips
                                                let maxStrips = 0;
                                                let remaining = panelLength;
                                                while (remaining >= crossW) {
                                                    remaining -= (crossW + KERF_WIDTH);
                                                    maxStrips++;
                                                }

                                                const userCount = parseInt(crosscutStripCount);
                                                const numStrips = userCount > 0 && userCount <= maxStrips ? userCount : maxStrips;

                                                if (grainOrientation === 'end-grain') {
                                                    width = (numStrips * boardThickness).toFixed(2);
                                                    length = panelWidth.toFixed(2);
                                                    thickness = crossW.toFixed(2);
                                                } else {
                                                    width = panelWidth.toFixed(2);
                                                    length = (numStrips * crossW).toFixed(2);
                                                    thickness = boardThickness.toFixed(2);
                                                }

                                                grain = grainOrientation === 'end-grain' ? 'End' : 'Face';
                                            }
                                        }

                                        return (
                                            <>
                                                <div className="flex items-center gap-1">
                                                    <span className="text-gray-600">Width:</span>
                                                    <span className={`font-bold ${width === '?' ? 'text-gray-400' : 'text-blue-700'}`}>
                                                        {width}"
                                                    </span>
                                                </div>
                                                <span className="text-gray-400">√ó</span>
                                                <div className="flex items-center gap-1">
                                                    <span className="text-gray-600">Length:</span>
                                                    <span className={`font-bold ${length === '?' ? 'text-gray-400' : 'text-blue-700'}`}>
                                                        {length}"
                                                    </span>
                                                </div>
                                                <span className="text-gray-400">√ó</span>
                                                <div className="flex items-center gap-1">
                                                    <span className="text-gray-600">Thick:</span>
                                                    <span className={`font-bold ${thickness === '?' ? 'text-gray-400' : 'text-blue-700'}`}>
                                                        {thickness}"
                                                    </span>
                                                </div>
                                                <span className="text-gray-400">|</span>
                                                <div className="flex items-center gap-1">
                                                    <span className="text-gray-600">Grain:</span>
                                                    <span className={`font-bold ${grain === '?' ? 'text-gray-400' : 'text-blue-700'}`}>
                                                        {grain}
                                                    </span>
                                                </div>
                                            </>
                                        );
                                    })()}
                                </div>
                            </div>
                        </div>
                        {/* END: Sticky Estimated Final Dimensions */}

                        <div className="bg-white rounded-lg shadow-lg p-8 no-print">
                            {step === 1 && (
                                <div>
                                    <h2 className="text-2xl font-bold text-amber-900 mb-4">
                                        Step 1: Input Raw Wood Dimensions
                                    </h2>
                                    <p className="text-gray-600 mb-6">
                                        Add your raw wood boards with their dimensions or load a template
                                    </p>

                                    <div className="mb-6 flex flex-wrap gap-3">
                                        <button
                                            onClick={() => loadTemplate('checkeredPattern')}
                                            className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2"
                                        >
                                            <Sparkles size={16} /> Checkered Pattern
                                        </button>
                                        <button
                                            onClick={() => loadTemplate('stripedPattern')}
                                            className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center gap-2"
                                        >
                                            <Sparkles size={16} /> Face Grain Stripes
                                        </button>
                                        <button
                                            onClick={() => loadTemplate('wideStripes')}
                                            className="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 flex items-center gap-2"
                                        >
                                            <Sparkles size={16} /> Wide Stripes
                                        </button>
                                        <button
                                            onClick={() => loadTemplate('threeWoodCheckered')}
                                            className="bg-rose-600 text-white px-4 py-2 rounded-lg hover:bg-rose-700 flex items-center gap-2"
                                        >
                                            <Sparkles size={16} /> Three Wood Checkered
                                        </button>
                                    </div>

                                    {boards.map((board) => (
                                        <div key={board.id} className="mb-4 p-3 bg-white border-2 border-amber-200 rounded-lg">
                                            <div className="flex items-center gap-3">
                                                <div
                                                    className="w-8 h-8 rounded flex-shrink-0"
                                                    style={{ backgroundColor: board.woodType.color }}
                                                />
                                                <div className="flex-1 space-y-2">
                                                    <select
                                                        value={board.woodType.name}
                                                        onChange={(e) => updateBoard(board.id, 'woodType',
                                                            WOOD_TYPES.find(w => w.name === e.target.value))}
                                                        className="w-full border-2 border-gray-300 rounded px-3 py-2 font-bold text-gray-900"
                                                    >
                                                        {WOOD_TYPES.map(wood => (
                                                            <option key={wood.name} value={wood.name}>{wood.name}</option>
                                                        ))}
                                                    </select>
                                                    <div className="flex gap-2">
                                                        <input
                                                            type="number"
                                                            step="0.125"
                                                            value={board.thickness}
                                                            onChange={(e) => updateBoard(board.id, 'thickness', e.target.value)}
                                                            className="w-20 border-2 border-gray-300 rounded px-2 py-1 text-sm"
                                                            placeholder="1.5"
                                                        />
                                                        <span className="text-gray-600 text-sm flex items-center">√ó </span>
                                                        <input
                                                            type="number"
                                                            step="0.125"
                                                            value={board.width}
                                                            onChange={(e) => updateBoard(board.id, 'width', e.target.value)}
                                                            className="w-20 border-2 border-gray-300 rounded px-2 py-1 text-sm"
                                                            placeholder="6"
                                                        />
                                                        <span className="text-gray-600 text-sm flex items-center">√ó </span>
                                                        <input
                                                            type="number"
                                                            step="0.125"
                                                            value={board.length}
                                                            onChange={(e) => updateBoard(board.id, 'length', e.target.value)}
                                                            className="w-20 border-2 border-gray-300 rounded px-2 py-1 text-sm"
                                                            placeholder="24"
                                                        />
                                                        <span className="text-gray-600 text-sm flex items-center">"</span>
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={() => removeBoard(board.id)}
                                                    className="text-red-500 hover:text-red-700 p-2 flex-shrink-0"
                                                    title="Remove board"
                                                >
                                                    <Trash2 size={20} />
                                                </button>
                                            </div>
                                        </div>
                                    ))}

                                    <button
                                        onClick={addBoard}
                                        className="mb-6 bg-amber-600 text-white px-4 py-2 rounded hover:bg-amber-700 flex items-center gap-2"
                                    >
                                        <Plus size={16} /> Add Wood Board
                                    </button>

                                    <button
                                        onClick={() => setStep(2)}
                                        disabled={boards.length === 0 || !boards.every(b => b.thickness && b.width && b.length)}
                                        className="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed font-bold flex items-center justify-center gap-2"
                                    >
                                        Next: Rip Cut <ArrowRight size={20} />
                                    </button>
                                </div>
                            )}

                            {step === 2 && (
                                <div>
                                    <h2 className="text-2xl font-bold text-amber-900 mb-4">
                                        Step 2: Plan Rip Cut Strips
                                    </h2>
                                    <p className="text-gray-600 mb-6">
                                        For each board, add strips with specific widths and quantities
                                    </p>

                                    <p className="text-sm text-gray-500 mb-6">
                                        Note: Kerf width of {KERF_WIDTH}" will be accounted for between cuts
                                    </p>

                                    {boards.map((board) => {
                                        const remaining = calculateBoardRemaining(board);
                                        const totalStrips = board.customStrips?.reduce((sum, s) => sum + s.quantity, 0) || 0;

                                        return (
                                            <div key={board.id} className="mb-6 p-4 border-2 border-amber-200 rounded-lg">
                                                <div className="flex items-center gap-3 mb-3">
                                                    <div
                                                        className="w-8 h-8 rounded"
                                                        style={{ backgroundColor: board.woodType.color }}
                                                    />
                                                    <div className="flex-1">
                                                        <h3 className="font-bold text-amber-900">
                                                            {board.woodType.name}
                                                        </h3>
                                                        <p className="text-sm text-gray-600">
                                                            {board.thickness}" √ó {board.width}" √ó {board.length}"
                                                        </p>
                                                    </div>
                                                    <div className="text-right">
                                                        <p className="text-sm font-medium text-gray-700">
                                                            {totalStrips} strips planned
                                                        </p>
                                                        <p className={`text-xs font-bold ${
                                                            remaining.status === 'insufficient' ? 'text-red-600' :
                                                            'text-green-600'
                                                        }`}>
                                                            {remaining.status === 'insufficient'
                                                                ? `Need ${Math.abs(remaining.remaining).toFixed(3)}" more wood!`
                                                                : remaining.status === 'waste'
                                                                ? `${remaining.remaining.toFixed(3)}" remaining`
                                                                : 'Perfect fit!'}
                                                        </p>
                                                    </div>
                                                </div>

                                                {board.customStrips && board.customStrips.length > 0 && (
                                                    <div className="mb-3 space-y-2">
                                                        {board.customStrips.map((strip, idx) => (
                                                            <div key={idx} className="flex items-center gap-2 p-2 bg-amber-50 rounded">
                                                                <span className="text-sm font-medium flex-1">
                                                                    {strip.quantity}√ó strips at {strip.width}" wide
                                                                </span>
                                                                <button
                                                                    onClick={() => removeCustomStrip(board.id, idx)}
                                                                    className="text-red-600 hover:text-red-800 p-1"
                                                                >
                                                                    <Trash2 size={16} />
                                                                </button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}

                                                <div className="flex gap-2">
                                                    <input
                                                        type="number"
                                                        min="1"
                                                        placeholder="Quantity"
                                                        id={`qty-${board.id}`}
                                                        defaultValue=""
                                                        className="w-24 border-2 border-gray-300 rounded px-3 py-2 text-sm"
                                                    />
                                                    <input
                                                        type="number"
                                                        step="0.125"
                                                        placeholder="Width (in)"
                                                        id={`width-${board.id}`}
                                                        className="w-32 border-2 border-gray-300 rounded px-3 py-2 text-sm"
                                                    />
                                                    <button
                                                        onClick={() => {
                                                            const qty = document.getElementById(`qty-${board.id}`).value;
                                                            const width = document.getElementById(`width-${board.id}`).value;
                                                            if (width && parseFloat(width) > 0 && qty && parseInt(qty) > 0) {
                                                                addCustomStrip(board.id, width, qty);
                                                                document.getElementById(`qty-${board.id}`).value = '';
                                                                document.getElementById(`width-${board.id}`).value = '';
                                                            }
                                                        }}
                                                        className="bg-amber-600 text-white px-4 py-2 rounded hover:bg-amber-700 flex items-center gap-1 text-sm"
                                                    >
                                                        <Plus size={16} /> Add Strips
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}

                                    <div className="flex gap-4">
                                        <button
                                            onClick={() => setStep(1)}
                                            className="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-bold flex items-center gap-2"
                                        >
                                            <ArrowLeft size={20} /> Back
                                        </button>
                                        <button
                                            onClick={calculateRippedStrips}
                                            disabled={
                                                !boards.every(b => b.customStrips && b.customStrips.length > 0) ||
                                                boards.some(b => calculateBoardRemaining(b).status === 'insufficient')
                                            }
                                            className="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed font-bold flex items-center justify-center gap-2"
                                        >
                                            Calculate Strips <ArrowRight size={20} />
                                        </button>
                                    </div>
                                </div>
                            )}

                            {step === 3 && (
                                <div>
                                    <h2 className="text-2xl font-bold text-amber-900 mb-4">
                                        Step 3: Arrange Ripped Strips
                                    </h2>
                                    <p className="text-gray-600 mb-6">
                                        Drag and drop to arrange your strips for the pattern
                                    </p>

                                    <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                                        <div className="text-sm text-blue-900">
                                            <p className="mb-2">
                                                <strong>Total Strips:</strong> {rippedStrips.length}
                                            </p>
                                            {rippedStrips.length > 0 && (() => {
                                                const postCutWidth = rippedStrips.reduce((sum, s) => sum + s.width, 0);
                                                const preCutWidth = postCutWidth + (rippedStrips.length - 1) * KERF_WIDTH;
                                                const length = rippedStrips[0].length;

                                                return (
                                                    <>
                                                        <p className="mb-1">
                                                            <strong>Panel Width (post-cut):</strong> {postCutWidth.toFixed(2)}"
                                                            <span className="text-blue-700 ml-2">(glued strips only)</span>
                                                        </p>
                                                        <p className="mb-1">
                                                            <strong>Panel Width (pre-cut):</strong> {preCutWidth.toFixed(2)}"
                                                            <span className="text-blue-700 ml-2">(includes {(rippedStrips.length - 1)} kerfs)</span>
                                                        </p>
                                                        <p>
                                                            <strong>Panel Length:</strong> {length}"
                                                        </p>
                                                    </>
                                                );
                                            })()}
                                        </div>
                                    </div>

                                    <div className="mb-6 space-y-1">
                                        {rippedStrips.map((strip, index) => {
                                            const maxWidth = Math.max(...rippedStrips.map(s => s.width));
                                            const heightScale = strip.width / maxWidth;
                                            const baseHeight = 48;
                                            const actualHeight = baseHeight * heightScale;

                                            return (
                                                <div
                                                    key={strip.id}
                                                    draggable
                                                    onDragStart={() => handleDragStartRipped(index)}
                                                    onDragOver={(e) => handleDragOverRipped(e, index)}
                                                    onDragEnd={() => setDraggedIndex(null)}
                                                    className="flex items-center gap-2 p-2 bg-white border-2 border-gray-300 rounded cursor-move hover:border-amber-500 transition-colors"
                                                >
                                                    <GripVertical size={16} className="text-gray-400 flex-shrink-0" />
                                                    <div
                                                        className="rounded flex-1"
                                                        style={{
                                                            backgroundColor: strip.woodType.color,
                                                            height: `${actualHeight}px`,
                                                            minHeight: '20px'
                                                        }}
                                                    />
                                                    <span className="text-xs font-mono text-gray-600 flex-shrink-0" style={{ width: '140px' }}>
                                                        {strip.woodType.name} {strip.width}" √ó {strip.length}"
                                                    </span>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    <div className="flex gap-4">
                                        <button
                                            onClick={() => setStep(2)}
                                            className="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-bold flex items-center gap-2"
                                        >
                                            <ArrowLeft size={20} /> Back
                                        </button>
                                        <button
                                            onClick={() => setStep(4)}
                                            className="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-bold flex items-center justify-center gap-2"
                                        >
                                            Next: Crosscut <ArrowRight size={20} />
                                        </button>
                                    </div>
                                </div>
                            )}

                            {step === 4 && (
                                <div>
                                    <h2 className="text-2xl font-bold text-amber-900 mb-4">
                                        Step 4: Crosscut Strip Width & Grain Orientation
                                    </h2>
                                    <p className="text-gray-600 mb-6">
                                        Enter the width for crosscutting and choose the grain orientation
                                    </p>

                                    <div className="mb-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Crosscut Strip Width (inches)
                                            </label>
                                            <input
                                                type="number"
                                                step="0.125"
                                                value={crosscutWidth}
                                                onChange={(e) => setCrosscutWidth(e.target.value)}
                                                className="w-full border-2 border-gray-300 rounded px-4 py-3 text-lg"
                                                placeholder="0.75"
                                            />
                                            <p className="text-sm text-gray-500 mt-2">
                                                Note: Kerf width of {KERF_WIDTH}" will be accounted for between cuts
                                            </p>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Number of Strips
                                            </label>
                                            <input
                                                type="number"
                                                min="1"
                                                value={crosscutStripCount}
                                                onChange={(e) => setCrosscutStripCount(e.target.value)}
                                                className="w-full border-2 border-gray-300 rounded px-4 py-3 text-lg"
                                                placeholder="Auto (max)"
                                            />
                                            <p className="text-sm text-gray-500 mt-2">
                                                {(() => {
                                                    const crossW = parseFloat(crosscutWidth);
                                                    const panelLength = rippedStrips[0]?.length || 0;
                                                    let maxStrips = 0;

                                                    if (crossW && crossW > 0 && panelLength > 0) {
                                                        let remaining = panelLength;
                                                        while (remaining >= crossW) {
                                                            remaining -= (crossW + KERF_WIDTH);
                                                            maxStrips++;
                                                        }
                                                    }

                                                    return maxStrips > 0 ? `Max: ${maxStrips} strips` : 'Enter width first';
                                                })()}
                                            </p>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Grain Orientation
                                            </label>
                                            <select
                                                value={grainOrientation}
                                                onChange={(e) => setGrainOrientation(e.target.value)}
                                                className="w-full border-2 border-gray-300 rounded px-4 py-3 text-lg"
                                            >
                                                <option value="end-grain">End Grain (crosscut width = thickness)</option>
                                                <option value="face-grain">Face Grain (original thickness)</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                                        <h3 className="font-bold text-blue-900 mb-2">Grain Orientation Guide:</h3>
                                        <div className="text-sm text-blue-800 space-y-2">
                                            <p><strong>End Grain:</strong> Strips are rotated 90¬∞ and glued end-to-end. Most durable for cutting. Final thickness = crosscut width.</p>
                                            <p><strong>Face Grain:</strong> Strips are glued face-to-face. Easier to make. Final thickness = original board thickness.</p>
                                        </div>
                                    </div>

                                    <div className="flex gap-4">
                                        <button
                                            onClick={() => setStep(3)}
                                            className="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-bold flex items-center gap-2"
                                        >
                                            <ArrowLeft size={20} /> Back
                                        </button>
                                        <button
                                            onClick={calculateCrosscutStrips}
                                            disabled={!crosscutWidth || parseFloat(crosscutWidth) <= 0}
                                            className="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed font-bold flex items-center justify-center gap-2"
                                        >
                                            Calculate Crosscut Strips <ArrowRight size={20} />
                                        </button>
                                    </div>
                                </div>
                            )}

                            {step === 5 && (
                                <div>
                                    <h2 className="text-2xl font-bold text-amber-900 mb-4">
                                        Step 5: Arrange Final Pattern
                                    </h2>
                                    <p className="text-gray-600 mb-6">
                                        Drag to rearrange, click to flip 180¬∞ for end-grain pattern
                                    </p>

                                    <div className="mb-6 space-y-2">
                                        {finalStrips.map((strip, index) => {
                                            const totalWidth = strip.segments.reduce((sum, s) => sum + s.width, 0);
                                            const segments = strip.flipped ? [...strip.segments].reverse() : strip.segments;

                                            return (
                                                <div
                                                    key={strip.id}
                                                    draggable
                                                    onDragStart={() => handleDragStartFinal(index)}
                                                    onDragOver={(e) => handleDragOverFinal(e, index)}
                                                    onDragEnd={() => setDraggedIndex(null)}
                                                    className="flex items-center gap-2 p-3 bg-white border-2 border-gray-300 rounded hover:border-amber-500 transition-colors"
                                                >
                                                    <GripVertical size={20} className="text-gray-400 cursor-move flex-shrink-0" />

                                                    <div className="flex flex-1 min-w-0" style={{ gap: '2px' }}>
                                                        {segments.map((seg, segIdx) => (
                                                            <div
                                                                key={segIdx}
                                                                className="h-12"
                                                                style={{
                                                                    backgroundColor: seg.woodType.color,
                                                                    width: `calc(${(seg.width / totalWidth) * 100}% - ${segIdx < segments.length - 1 ? '1px' : '0px'})`,
                                                                    minWidth: '4px'
                                                                }}
                                                                title={seg.woodType.name}
                                                            />
                                                        ))}
                                                    </div>

                                                    <button
                                                        onClick={() => toggleFlip(index)}
                                                        className={`px-3 py-2 rounded transition-colors flex-shrink-0 ${
                                                            strip.flipped
                                                                ? 'bg-amber-600 text-white hover:bg-amber-700'
                                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                        }`}
                                                        title="Flip 180¬∞"
                                                    >
                                                        <RotateCw size={16} />
                                                    </button>

                                                    <span className="text-sm font-mono text-gray-600 flex-shrink-0" style={{ width: '80px' }}>
                                                        {strip.flipped ? '‚Ü∫ Flipped' : 'Normal'}
                                                    </span>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    <div className="flex gap-4">
                                        <button
                                            onClick={() => setStep(4)}
                                            className="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-bold flex items-center gap-2"
                                        >
                                            <ArrowLeft size={20} /> Back
                                        </button>
                                        <button
                                            onClick={() => setStep(6)}
                                            className="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-bold flex items-center justify-center gap-2"
                                        >
                                            View Final Design <ArrowRight size={20} />
                                        </button>
                                    </div>
                                </div>
                            )}

                            {step === 6 && (
                                <div>
                                    <h2 className="text-2xl font-bold text-amber-900 mb-4">
                                        Step 6: Final Cutting Board Design
                                    </h2>
                                    <p className="text-gray-600 mb-6">
                                        Your cutting board design is complete!
                                    </p>

                                    <div className="mb-6 p-6 bg-green-50 rounded-lg border-2 border-green-200">
                                        <h3 className="text-xl font-bold text-green-900 mb-4">Bill of Materials (BOM)</h3>
                                        <p className="text-sm text-green-700 mb-4">Raw material needed (includes kerf waste)</p>
                                        {(() => {
                                            const boardThickness = rippedStrips[0]?.thickness || 0;
                                            const panelWidth = finalStrips[0]?.segments.reduce((sum, seg) => sum + seg.width, 0) || 0;
                                            const numCrosscutStrips = finalStrips.length;

                                            // Calculate material dimensions needed (with kerfs)
                                            let materialWidth, materialLength;

                                            if (grainOrientation === 'end-grain') {
                                                // Material width includes kerfs between crosscut strips when rotated
                                                materialWidth = numCrosscutStrips * boardThickness + (numCrosscutStrips - 1) * KERF_WIDTH;
                                                materialLength = panelWidth;
                                            } else {
                                                // Face-grain
                                                materialWidth = panelWidth;
                                                materialLength = numCrosscutStrips * parseFloat(crosscutWidth) + (numCrosscutStrips - 1) * KERF_WIDTH;
                                            }

                                            // Group by wood type
                                            const woodTypes = {};
                                            boards.forEach(board => {
                                                const woodName = board.woodType.name;
                                                if (!woodTypes[woodName]) {
                                                    woodTypes[woodName] = {
                                                        color: board.woodType.color,
                                                        thickness: parseFloat(board.thickness),
                                                        widthUsed: 0,
                                                        lengthNeeded: materialLength
                                                    };
                                                }

                                                // Calculate width used by this board's strips
                                                if (board.customStrips && board.customStrips.length > 0) {
                                                    board.customStrips.forEach(strip => {
                                                        woodTypes[woodName].widthUsed += strip.width * strip.quantity;
                                                    });
                                                }
                                            });

                                            return (
                                                <div className="space-y-3">
                                                    {Object.entries(woodTypes).map(([woodName, data]) => {
                                                        const boardFeet = (data.thickness * data.widthUsed * data.lengthNeeded) / 144;

                                                        return (
                                                            <div key={woodName} className="flex items-center gap-3 p-3 bg-white rounded-lg">
                                                                <div
                                                                    className="w-8 h-8 rounded"
                                                                    style={{ backgroundColor: data.color }}
                                                                />
                                                                <div className="flex-1">
                                                                    <div className="font-bold text-gray-900">{woodName}</div>
                                                                    <div className="text-sm text-gray-600">
                                                                        {data.thickness}" thick √ó {data.widthUsed.toFixed(2)}" wide √ó {data.lengthNeeded.toFixed(2)}" long
                                                                    </div>
                                                                </div>
                                                                <div className="text-right">
                                                                    <div className="text-xs text-gray-500">Board Feet</div>
                                                                    <div className="font-bold text-green-700">
                                                                        {boardFeet.toFixed(2)} BF
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                    <div className="pt-3 border-t-2 border-green-200">
                                                        <p className="text-sm text-green-800 mb-2">
                                                            <strong>Material Dimensions (with kerfs):</strong>
                                                        </p>
                                                        <p className="text-sm text-green-700 mb-1">
                                                            Width: {materialWidth.toFixed(2)}" (includes {(numCrosscutStrips - 1)} kerfs = {((numCrosscutStrips - 1) * KERF_WIDTH).toFixed(3)}" waste)
                                                        </p>
                                                        <p className="text-sm text-green-700">
                                                            Length: {materialLength.toFixed(2)}"
                                                        </p>
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </div>

                                    <div className="mb-6 p-4 bg-white border-4 border-amber-200 rounded-lg">
                                        <h3 className="font-bold text-amber-900 mb-3 text-center">
                                            {grainOrientation === 'end-grain' ? 'End-Grain' : 'Face-Grain'} Pattern Preview
                                        </h3>
                                        <div className="flex justify-center">
                                            <div className="inline-block border-2 border-gray-400">
                                                {(() => {
                                                    // Calculate scale: maintain aspect ratio but ensure visibility
                                                    const crossW = parseFloat(crosscutWidth);
                                                    const maxSegWidth = Math.max(...finalStrips.flatMap(s => s.segments.map(seg => seg.width)));

                                                    // Use larger scale, aiming for at least 20px per smallest strip
                                                    const minStripWidth = Math.min(...finalStrips.flatMap(s => s.segments.map(seg => seg.width)));
                                                    const minPixelsPerStrip = 20;
                                                    const pixelsPerInch = minPixelsPerStrip / minStripWidth;

                                                    // Cap maximum total width at 600px
                                                    const totalWidth = maxSegWidth * pixelsPerInch * finalStrips[0].segments.length;
                                                    const scale = totalWidth > 600 ? 600 / totalWidth : 1;
                                                    const finalPixelsPerInch = pixelsPerInch * scale;

                                                    return finalStrips.map((strip) => {
                                                        const segments = strip.flipped ? [...strip.segments].reverse() : strip.segments;
                                                        const rowHeight = crossW * finalPixelsPerInch;

                                                        return (
                                                            <div key={strip.id} className="flex">
                                                                {segments.map((seg, segIdx) => {
                                                                    const segWidth = seg.width * finalPixelsPerInch;
                                                                    return (
                                                                        <div
                                                                            key={segIdx}
                                                                            style={{
                                                                                backgroundColor: seg.woodType.color,
                                                                                width: `${segWidth}px`,
                                                                                height: `${rowHeight}px`,
                                                                                minWidth: '2px',
                                                                                minHeight: '2px',
                                                                                border: '0.5px solid rgba(0,0,0,0.1)'
                                                                            }}
                                                                            title={`${seg.woodType.name}${strip.flipped ? ' (flipped)' : ''}`}
                                                                        />
                                                                    );
                                                                })}
                                                            </div>
                                                        );
                                                    });
                                                })()}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="mb-6 no-print">
                                        <button
                                            onClick={() => window.print()}
                                            className="w-full bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 font-bold flex items-center justify-center gap-2"
                                        >
                                            üñ®Ô∏è Print Build Instructions
                                        </button>
                                    </div>

                                    <div className="flex gap-4 no-print">
                                        <button
                                            onClick={() => setStep(5)}
                                            className="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-bold flex items-center gap-2"
                                        >
                                            <ArrowLeft size={20} /> Back
                                        </button>
                                        <button
                                            onClick={() => {
                                                setStep(1);
                                                setBoards([]);
                                                setRipWidth('');
                                                setRippedStrips([]);
                                                setCrosscutWidth('');
                                                setCrosscutStripCount('');
                                                setFinalStrips([]);
                                                setGrainOrientation('end-grain');
                                            }}
                                            className="flex-1 bg-amber-600 text-white px-6 py-3 rounded-lg hover:bg-amber-700 font-bold"
                                        >
                                            Start New Design
                                        </button>
                                    </div>

                                    {/* Printable Build Instructions */}
                                    <div id="printable-instructions" className="print-only" style={{fontSize: '13px'}}>
                                        <h1 style={{fontSize: '19px', fontWeight: 'bold', marginBottom: '12px', borderBottom: '2px solid black', paddingBottom: '6px'}}>
                                            Cutting Board Build Instructions
                                        </h1>

                                        <div style={{marginBottom: '12px'}}>
                                            <h2 style={{fontSize: '14px', fontWeight: 'bold', marginBottom: '6px'}}>Final Board Specifications</h2>
                                            <table style={{width: '100%', borderCollapse: 'collapse', marginBottom: '12px'}}>
                                                <tbody>
                                                    <tr style={{borderBottom: '1px solid #ccc'}}>
                                                        <td style={{padding: '5px', fontWeight: 'bold'}}>Width:</td>
                                                        <td style={{padding: '5px'}}>{getFinalDimensions().width}"</td>
                                                        <td style={{padding: '5px', fontWeight: 'bold'}}>Length:</td>
                                                        <td style={{padding: '5px'}}>{getFinalDimensions().length}"</td>
                                                    </tr>
                                                    <tr style={{borderBottom: '1px solid #ccc'}}>
                                                        <td style={{padding: '5px', fontWeight: 'bold'}}>Thickness:</td>
                                                        <td style={{padding: '5px'}}>{getFinalDimensions().thickness}"</td>
                                                        <td style={{padding: '5px', fontWeight: 'bold'}}>Grain:</td>
                                                        <td style={{padding: '5px'}}>{grainOrientation === 'end-grain' ? 'End-Grain' : 'Face-Grain'}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>

                                        {(() => {
                                            const boardThickness = rippedStrips[0]?.thickness || 0;
                                            const panelWidth = finalStrips[0]?.segments.reduce((sum, seg) => sum + seg.width, 0) || 0;
                                            const numCrosscutStrips = finalStrips.length;

                                            const woodTypes = {};
                                            boards.forEach(board => {
                                                const woodName = board.woodType.name;
                                                if (!woodTypes[woodName]) {
                                                    woodTypes[woodName] = {
                                                        thickness: parseFloat(board.thickness),
                                                        widthUsed: 0
                                                    };
                                                }
                                                if (board.customStrips && board.customStrips.length > 0) {
                                                    board.customStrips.forEach(strip => {
                                                        woodTypes[woodName].widthUsed += strip.width * strip.quantity;
                                                    });
                                                }
                                            });

                                            return (
                                                <>
                                                    <div style={{marginBottom: '12px'}}>
                                                        <h2 style={{fontSize: '14px', fontWeight: 'bold', marginBottom: '6px'}}>Materials Required</h2>
                                                        <table style={{width: '100%', borderCollapse: 'collapse'}}>
                                                            <thead>
                                                                <tr style={{borderBottom: '2px solid black', backgroundColor: '#f5f5f5'}}>
                                                                    <th style={{padding: '5px', textAlign: 'left'}}>Wood Type</th>
                                                                    <th style={{padding: '5px', textAlign: 'left'}}>Thickness</th>
                                                                    <th style={{padding: '5px', textAlign: 'left'}}>Width Needed</th>
                                                                    <th style={{padding: '5px', textAlign: 'left'}}>Length Needed</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {Object.entries(woodTypes).map(([woodName, data]) => (
                                                                    <tr key={woodName} style={{borderBottom: '1px solid #ccc'}}>
                                                                        <td style={{padding: '5px'}}>{woodName}</td>
                                                                        <td style={{padding: '5px'}}>{data.thickness}"</td>
                                                                        <td style={{padding: '5px'}}>{data.widthUsed.toFixed(2)}"</td>
                                                                        <td style={{padding: '5px'}}>{panelWidth.toFixed(2)}"</td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </div>

                                                    <div style={{marginBottom: '12px'}}>
                                                        <h2 style={{fontSize: '14px', fontWeight: 'bold', marginBottom: '6px'}}>Rip Cuts</h2>
                                                        <table style={{width: '100%', borderCollapse: 'collapse'}}>
                                                            <thead>
                                                                <tr style={{borderBottom: '2px solid black', backgroundColor: '#f5f5f5'}}>
                                                                    <th style={{padding: '5px', textAlign: 'left'}}>Wood Type</th>
                                                                    <th style={{padding: '5px', textAlign: 'left'}}>Strip Width</th>
                                                                    <th style={{padding: '5px', textAlign: 'left'}}>Quantity</th>
                                                                    <th style={{padding: '5px', textAlign: 'left'}}>Strip Length</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {boards.map((board, idx) =>
                                                                    board.customStrips && board.customStrips.map((strip, stripIdx) => (
                                                                        <tr key={`${idx}-${stripIdx}`} style={{borderBottom: '1px solid #ccc'}}>
                                                                            <td style={{padding: '5px'}}>{board.woodType.name}</td>
                                                                            <td style={{padding: '5px'}}>{strip.width}"</td>
                                                                            <td style={{padding: '5px'}}>{strip.quantity}</td>
                                                                            <td style={{padding: '5px'}}>{board.length}"</td>
                                                                        </tr>
                                                                    ))
                                                                )}
                                                            </tbody>
                                                        </table>
                                                        <p style={{marginTop: '6px', fontSize: '11px'}}>
                                                            Total strips after rip cuts: {rippedStrips.length} | Panel size: {panelWidth.toFixed(2)}" √ó {rippedStrips[0]?.length || 0}"
                                                        </p>
                                                    </div>

                                                    <div style={{marginBottom: '12px'}}>
                                                        <h2 style={{fontSize: '14px', fontWeight: 'bold', marginBottom: '6px'}}>Crosscut Specifications</h2>
                                                        <table style={{width: '100%', borderCollapse: 'collapse'}}>
                                                            <tbody>
                                                                <tr style={{borderBottom: '1px solid #ccc'}}>
                                                                    <td style={{padding: '5px', fontWeight: 'bold', width: '40%'}}>Crosscut Strip Width:</td>
                                                                    <td style={{padding: '5px'}}>{parseFloat(crosscutWidth).toFixed(2)}"</td>
                                                                </tr>
                                                                <tr style={{borderBottom: '1px solid #ccc'}}>
                                                                    <td style={{padding: '5px', fontWeight: 'bold'}}>Number of Crosscut Strips:</td>
                                                                    <td style={{padding: '5px'}}>{numCrosscutStrips}</td>
                                                                </tr>
                                                                <tr style={{borderBottom: '1px solid #ccc'}}>
                                                                    <td style={{padding: '5px', fontWeight: 'bold'}}>Each Crosscut Strip Size:</td>
                                                                    <td style={{padding: '5px'}}>{parseFloat(crosscutWidth).toFixed(2)}" √ó {panelWidth.toFixed(2)}"</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>

                                                    <div style={{marginBottom: '12px', pageBreakBefore: 'avoid'}}>
                                                        <h2 style={{fontSize: '14px', fontWeight: 'bold', marginBottom: '6px'}}>Pattern Preview</h2>
                                                        <div style={{border: '2px solid black', padding: '8px', display: 'inline-block'}}>
                                                            {(() => {
                                                                // Calculate scale for print
                                                                const crossW = parseFloat(crosscutWidth);
                                                                const maxSegWidth = Math.max(...finalStrips.flatMap(s => s.segments.map(seg => seg.width)));

                                                                // Use larger scale, aiming for at least 15px per smallest strip (smaller for print)
                                                                const minStripWidth = Math.min(...finalStrips.flatMap(s => s.segments.map(seg => seg.width)));
                                                                const minPixelsPerStrip = 15;
                                                                const pixelsPerInch = minPixelsPerStrip / minStripWidth;

                                                                // Cap maximum total width at 500px for print
                                                                const totalWidth = maxSegWidth * pixelsPerInch * finalStrips[0].segments.length;
                                                                const scale = totalWidth > 500 ? 500 / totalWidth : 1;
                                                                const finalPixelsPerInch = pixelsPerInch * scale;

                                                                return finalStrips.map((strip, stripIdx) => {
                                                                    const segments = strip.flipped ? [...strip.segments].reverse() : strip.segments;
                                                                    const rowHeight = crossW * finalPixelsPerInch;
                                                                    return (
                                                                        <div key={stripIdx} style={{display: 'flex'}}>
                                                                            {segments.map((seg, segIdx) => {
                                                                                const segWidth = seg.width * finalPixelsPerInch;
                                                                                return (
                                                                                    <div
                                                                                        key={segIdx}
                                                                                        style={{
                                                                                            backgroundColor: seg.woodType.color,
                                                                                            width: `${segWidth}px`,
                                                                                            height: `${rowHeight}px`,
                                                                                            minWidth: '2px',
                                                                                            minHeight: '2px',
                                                                                            border: '0.5px solid rgba(0,0,0,0.1)'
                                                                                        }}
                                                                                    />
                                                                                );
                                                                            })}
                                                                        </div>
                                                                    );
                                                                });
                                                            })()}
                                                        </div>
                                                    </div>

                                                    <div style={{marginTop: '16px', paddingTop: '12px', borderTop: '2px solid black'}}>
                                                        <p style={{fontSize: '10px', fontStyle: 'italic'}}>
                                                            Generated by Cutting Board Designer<br/>
                                                            Date: {new Date().toLocaleDateString()}<br/>
                                                            Design: {grainOrientation === 'end-grain' ? 'End-Grain' : 'Face-Grain'} - {getFinalDimensions().width}" √ó {getFinalDimensions().length}" √ó {getFinalDimensions().thickness}"
                                                        </p>
                                                    </div>
                                                </>
                                            );
                                        })()}
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="mt-8 text-center text-sm text-gray-600 no-print">
                            <p>üí° Tip: Different wood species create beautiful contrast patterns</p>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CuttingBoardDesigner />);
    </script>
</body>
</html>
